version: '3.0'
services:
  corestub:
    build:
      context: ../corestub
      args:
        - GITHUB_TOKEN
    environment:
      - SC_GRPC_HOST_ADDR=0.0.0.0:10000
      - LOCAL_SURFACE_PATH=/tmp/fixtures/surfaces
    volumes:
      - fixture_vol:/tmp/fixtures

  api:
    build: ../api
    depends_on:
      - corestub
    ports:
      - '8080:8080'
    environment:
      - NO_AUTH=true
      - HTTP_ONLY=true
      - HOST_ADDR=0.0.0.0:8080
      - STITCH_GRPC_ADDR=corestub:10000
      - MANIFEST_PATH=/tmp/fixtures/manifests
      - LOCAL_SURFACE_PATH=/tmp/fixtures/surfaces
    volumes:
      - fixture_vol:/tmp/fixtures

  test:
    build: .
    depends_on:
      - api
    environment:
      - SC_API_HOST_ADDR=http://api:8080
      - FIXTURES_PATH=/tmp/fixtures
    volumes:
      - fixture_vol:/tmp/fixtures
volumes:
  fixture_vol:
    driver_opts:
      type: tmpfs
      device: tmpfs
